# owntone

[![Build Status](https://jenkins.sudo.is/buildStatus/icon?job=ben%2Fbuild-owntone%2Fmain&style=flat-square)](https://jenkins.sudo.is/job/ben/job/build-owntone/job/main/)
[![git](https://www.sudo.is/readmes/git.sudo.is-ben.svg)](https://git.sudo.is/ben/build-owntone)
[![github](https://www.sudo.is/readmes/github-benediktkr.svg)](https://github.com/benediktkr/build-owntone)
[![matrix](https://www.sudo.is/readmes/matrix-ben-sudo.is.svg)](https://matrix.to/#/@ben:sudo.is)

A custom build of the latest stable version of [`owntone`](https://github.com/owntone/owntone-server).

[![owntone logo](owntone.png)](https://github.com/owntone)

This build is published as both a Docker container and `.deb` package

This build includes some (minor) custom changes to Owntone

 * Attempting to use a dark theme (css was generated by the Dark Reader
   extension for Firefox).
 * Web UI built without minimized javascript
 * Web socket is access by the Web UI on `/ws` (requires reverse proxy) instead of
   separate port (see [`build-web.sh`](build/build-web.sh))
 * Example nginx vhost config file is included
   (see [`01-owntone.conf`](etc/nginx/sites-available/01-owntone.conf)).

TODO changes:

 * Change the default action to add an item to the queue instead of replacing the queue (see notes below). On
   a phone or touchscreen it is not so easy to tap the hamburger menu and I often accidentally wipe out my
   current queue.

To forward mdns packets from the host network to the contaner:

```shell
mdns-repeater eth1 docker0
```

## Changes

A deeper explanation of the changes made to OwnTone in these builds, and the reasoning
for them.

I don't want to have to maintain a whole fork of OwnTone, and these are all
relatively small and simple changes, so they are simply applied on build time
with shell scripts.

###

By default OwnTone will spawn a websocket server on port thats separate from the main
port (used for the API and Web UI), which are configured in `owntone.conf`:

```conf
general {
    # TCP port to listen on. Default port is 3689 (daap)
    port = 3689
    # Set this if you want the server to bind to a specific IP Address.
    # Default is to listen on all IP addresses
    #bind_address = "0.0.0.0"

    wesocket_port = 3688
    # Websocket interface to bind listener to. Default is to listen on all interfaces
    websocket_interface = "0.0.0.0"
```

If you want to have a reverse proxy in front of OwnTone, serving all of the traffic
including the websocket server, you can simply make OwnTone only listen on

```conf
general {
    # TCP port to listen on. Default port is 3689 (daap)
    port = 3689
    bind_address = "127.0.0.1"
    # default:
    #bind_address = "0.0.0.0"

    websocket_port = 3688
    websocket_interface = "127.0.0.1"
    # default:
    #websocket_interface = "0.0.0.0"
}
```

If you want to have a reverse proxy in front of OwnTone, that requires you to bind
the reverse proxy in front of the websocket port to a different IP than OwnTone itself
binds it to (or run OwnTone in docker without host networking), or assign another ip
address to your OwnTone host.

Normally the Web Interface will access the web socket on a separate port, which it gets
from `websocket_port` on `/api/config`, which is defined in `owntone.conf`:



Since I would prefer to not have to use a separate
port and nginx vhost for the websocket, I wanted to

```diff
diff --git a/web-src/src/App.vue b/web-src/src/App.vue
index 0636fa10..1f6b0bc7 100644
--- a/web-src/src/App.vue
+++ b/web-src/src/App.vue
@@ -168,6 +168,7 @@ export default {
           vm.$store.state.config.websocket_port
       }

+      wsUrl = protocol + window.location.hostname + '/ws'
       const socket = new ReconnectingWebSocket(wsUrl, 'notify', {
         reconnectInterval: 1000,
         maxReconnectInterval: 2000
```

## notes

### how to enable the dark reader theme

see: https://stackoverflow.com/questions/62797830/using-dark-reader-extension-code-for-your-own-website

exported css file: `dark-reader/dark-reader.css`

exported via chrome on mac since it is broken on firefox: https://github.com/darkreader/darkreader/issues/11638


### web-src

we dont want to have the websocket listening on its own port, because we have a reverse proxy. but we also dont want to maintain a fork.

it turns out that its somewhat easy to change this. the url to the websocket gets set as `wsUrl` in `web-src/src/App.vue`. first, we change it to be

```javascript
let wsUrl = protocol + window.location.hostname + "/ws"
```

then save the `git diff` as a `.patch` file with

```shell
cd owntone-server
git diff --no-prefix --patch > ../builder/wsurl.patch
```
saved the change as a `.patch` file. then we need to build the web ui ourselves, and
first apply the `.patch` file.


this is the `git diff` of the change:

```console
$ git diff
diff --git a/web-src/src/App.vue b/web-src/src/App.vue
index 0636fa10..a1b45146 100644
--- a/web-src/src/App.vue
+++ b/web-src/src/App.vue
@@ -154,8 +154,7 @@ export default {
       let wsUrl =
         protocol +
         window.location.hostname +
-        ':' +
-        vm.$store.state.config.websocket_port
+        "/ws"

       if (import.meta.env.DEV && import.meta.env.VITE_OWNTONE_URL) {
         // If we are running in development mode, construct the websocket url
```

## notes on the build

this builds a `.deb` file (that will be available on
[`apt.sudo.is`](https://apt.sudo.is) in the future (when pipelines for
this repo has been figured out), following [the build section of the
documentation](https://owntone.github.io/owntone-server/building/).

this image is based on the `ubuntu:latest` base image, because of the
complex dependencies, and i was not able to figure out how to compile
a static binary. i tried following the github pipeline they have to
build a `.deb` but found it too complex and built a simple `.deb` with
`fpm`. the image compiles owntone and builds the `.deb` package in the
`builder` stage, and then copies te `.deb` file over in the `final`
stage and installs it.

the dependencies are listed in [`deps.txt`](builds/deps.txt) to install them in
the `base` stage in docker, so that they wouldnt get re-installed every time
the build has changed. the dependencies for running are slightly slammer than
the dependencies for building.

## run

To run as a non-root user, you need to use `avahi-daemon` and `dbus` from the
host (which sort of defeats the purpose):

```shell
docker run \
    -it \
    --name owntone \
    --net=host \
    --privileged \
    -v /var/run/dbus:/var/run/dbus \
    -v /run/avahi-daemon/socket:/run/avahi-daemon/socket \
    -v owntone.conf:/etc/owntone.conf \
    -v owntone.log:/var/log/owntone.log \
    -v cache/:/var/cache/owntone \
    -v music/:/srv/music \
    git.sudo.is/ben/owntone-server:latest
```

note that you can change the defaults paths `/srv/music` and
`/var/cache/owntone` in `owntone.conf` to better suit your needs, if
you want.

the container starts as root, and then the `owntone` binary `setuid`s
itself down to the user that you have specified in
`owntone.conf`. note that this username (cant specify uid) has to
exist in the container. if you want to change it you can rebuild the
container with different `UID` and `GID` build args, or create a new
user in a custom `entrypoint.sh` script. you can also start the
container as non-root, as long as you make sure that the paths that
owntone wants to write to are writable to that user (mounts).

## partial filescans

there is an open PR [`owntone-server#1179`](https://github.com/owntone/owntone-server/pull/1179)
from [:github: whatdoineed2do](https://github.com/whatdoineed2dothat) that
adds support for partial library file scans (very useful when you mainly listen to podcasts). my builds are currently
rebasing that branch onto the main owntone branch before building, meaning that these builds currently have support
for partial filescans.

they can be triggered through the api with:

```shell
scan_path=/media/audio/podcasts
curl -X PUT "https://${owntone_url}/api/update?kind=files&path=${scan_path}"
```

this branch also includes some rather nice UI improvements.

## own improvements of the web ui

 * try to get the dark-reader css to work
 * when clicking a podcast, default to adding it to the queue instead of replacing the queue.
   probably: [`/src/webapi/index.js#L92`](https://github.com/owntone/owntone-server/blob/master/web-src/src/webapi/index.js#L78-L112)
   should at least provide enough clues to find it in the html (?)

clicking on an item sends a `POST` request `/api/queue/items/add?uris=library:track:40397&shuffle=false&clear=true&playback=start`.

the request paramaters translate to a more readable:

```json
{
  "uris": "library:track:1234",
  "shuffle": false,
  "clear": true,
  "playback": start
}
```

so `"clear"` is the issue.
