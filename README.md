# owntone

[![Build Status](https://jenkins.sudo.is/buildStatus/icon?job=ben%2Fbuild-owntone%2Fmain&style=flat-square)](https://jenkins.sudo.is/job/ben/job/build-owntone/job/main/)
[![git](https://www.sudo.is/readmes/git.sudo.is-ben.svg)](https://git.sudo.is/ben/build-owntone)
[![github](https://www.sudo.is/readmes/github-benediktkr.svg)](https://github.com/benediktkr/build-owntone)
[![matrix](https://www.sudo.is/readmes/matrix-ben-sudo.is.svg)](https://matrix.to/#/@ben:sudo.is)

A custom build of the latest stable version of [`owntone`](https://github.com/owntone/owntone-server).

[![owntone logo](owntone.png)](https://github.com/owntone)

This build includes some (minor) custom changes to Owntone, and builds both a `.deb` pacakge and Docker 
container. The upstream repo points to a docker container from linuximage.io, but they require running as 
root to run whole init system inside the container.  

 * Attempting to include a dark theme generated by the Dark Reader extension for Firefox.
 * Builds the Web UI (see [`build/build-web.sh`](build/build-web.sh)). The javascript is not minimized.
 * Support in the frontend for using a websocket on `/ws` instead of needing a separate port. Instead
   of maintainig a whole fork for this, we just inject a re-definition of the `wsUrl` variable in `App.vue` 
   with `sed` before building the web client (see [`build/web-change-ws-url.sh`](build/web-change-ws-url.sh))
 * Example nginx reverse proxy config (supporting `/ws`) and systemd unit files are included.

TODO changes:

 * Change the default action to add an item to the queue instead of replacing the queue (see notes below). On 
   a phone or touchscreen it is not so easy to tap the hamburger menu and I often accidentally wipe out my 
   current queue.

## notes

### how to enable the dark reader theme

see: https://stackoverflow.com/questions/62797830/using-dark-reader-extension-code-for-your-own-website

exported css file: `dark-reader/dark-reader.css`

exported via chrome on mac since it is broken on firefox: https://github.com/darkreader/darkreader/issues/11638


### web-src

we dont want to have the websocket listening on its own port, because we have a reverse proxy. but we also dont want to maintain a fork.

it turns out that its somewhat easy to change this. the url to the websocket gets set as `wsUrl` in `web-src/src/App.vue`. first, we change it to be

```javascript
let wsUrl = protocol + window.location.hostname + "/ws"
```

then save the `git diff` as a `.patch` file with

```shell
cd owntone-server
git diff --no-prefix --patch > ../builder/wsurl.patch
```
saved the change as a `.patch` file. then we need to build the web ui ourselves, and 
first apply the `.patch` file.


this is the `git diff` of the change:

```console
$ git diff
diff --git a/web-src/src/App.vue b/web-src/src/App.vue
index 0636fa10..a1b45146 100644
--- a/web-src/src/App.vue
+++ b/web-src/src/App.vue
@@ -154,8 +154,7 @@ export default {
       let wsUrl =
         protocol +
         window.location.hostname +
-        ':' +
-        vm.$store.state.config.websocket_port
+        "/ws"

       if (import.meta.env.DEV && import.meta.env.VITE_OWNTONE_URL) {
         // If we are running in development mode, construct the websocket url
```

## notes on the build

this builds a `.deb` file (that will be available on
[`apt.sudo.is`](https://apt.sudo.is) in the future (when pipelines for
this repo has been figured out), following [the build section of the
documentation](https://owntone.github.io/owntone-server/building/).

this image is based on the `ubuntu:latest` base image, because of the
complex dependencies, and i was not able to figure out how to compile
a static binary. i tried following the github pipeline they have to
build a `.deb` but found it too complex and built a simple `.deb` with
`fpm`. the image compiles owntone and builds the `.deb` package in the
`builder` stage, and then copies te `.deb` file over in the `final`
stage and installs it.

the dependencies are listed in [`deps.txt`](builds/deps.txt) to install them in
the `base` stage in docker, so that they wouldnt get re-installed every time
the build has changed. the dependencies for running are slightly slammer than
the dependencies for building.

## run

```shell
docker run --name owntone -it --net=host \
   -v owntone.conf:/etc/owntone.conf \
   -v owntone.log:/var/log/owntone.log \
   -v cache/:/var/cache/owntone \
   -v music/:/srv/music \
   git.sudo.is/ben/owntone
```

note that you can change the defaults paths `/srv/music` and
`/var/cache/owntone` in `owntone.conf` to better suit your needs, if
you want.

the container starts as root, and then the `owntone` binary `setuid`s
itself down to the user that you have specified in
`owntone.conf`. note that this username (cant specify uid) has to
exist in the container. if you want to change it you can rebuild the
container with different `UID` and `GID` build args, or create a new
user in a custom `entrypoint.sh` script. you can also start the
container as non-root, as long as you make sure that the paths that
owntone wants to write to are writable to that user (mounts).

## partial filescans

there is an open PR [`owntone-server#1179`](https://github.com/owntone/owntone-server/pull/1179)
from [:github: whatdoineed2do](https://github.com/whatdoineed2dothat) that
adds support for partial library file scans (very useful when you mainly listen to podcasts). my builds are currently
rebasing that branch onto the main owntone branch before building, meaning that these builds currently have support
for partial filescans.

they can be triggered through the api with:

```shell
scan_path=/media/audio/podcasts
curl -X PUT "https://${owntone_url}/api/update?kind=files&path=${scan_path}"
```

this branch also includes some rather nice UI improvements.

## own improvements of the web ui

 * try to get the dark-reader css to work
 * when clicking a podcast, default to adding it to the queue instead of replacing the queue.
   probably: [`/src/webapi/index.js#L92`](https://github.com/owntone/owntone-server/blob/master/web-src/src/webapi/index.js#L78-L112)
   should at least provide enough clues to find it in the html (?)

clicking on an item sends a `POST` request `/api/queue/items/add?uris=library:track:40397&shuffle=false&clear=true&playback=start`.

the request paramaters translate to a more readable:

```json
{
  "uris": "library:track:1234",
  "shuffle": false,
  "clear": true,
  "playback": start
}
```

so `"clear"` is the issue.
